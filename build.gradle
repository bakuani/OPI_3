import javax.sound.sampled.*
import javax.xml.parsers.DocumentBuilderFactory

plugins {
    id 'org.springframework.boot' version '3.4.1'
    id 'io.spring.dependency-management' version '1.1.0'
    id 'java'
}

version = project.findProperty('projectVersion') ?: '1.0'
def mainClass = project.findProperty('mainClassName') ?: 'com.example.Main'

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

allprojects {
    group = 'ru.ani'
    description = '–ü—Ä–æ–µ–∫—Ç Web4 (Backend)'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter'

    compileOnly 'org.projectlombok:lombok:1.18.30'
    annotationProcessor 'org.projectlombok:lombok:1.18.30'

    runtimeOnly 'org.postgresql:postgresql:42.7.4'

    implementation 'org.springframework.boot:spring-boot-starter-security'

    implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'

    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

jar {
    manifest {
        attributes(
                'Main-Class': mainClass,
                'Implementation-Version': project.version
        )
    }
}

tasks.register('compile') {
    group = 'Build'
    description = '–ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤'
    dependsOn 'classes'
}

tasks.register('buildJar') {
    group = 'Build'
    description = '–°–±–æ—Ä–∫–∞ jar-—Ñ–∞–π–ª–∞'
    dependsOn 'compile', 'jar'
    finalizedBy(unitTest)
    finalizedBy(music)
    finalizedBy(scp)
}

tasks.register('cleanArtefacts') {
    description = '–û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏'
}

//TODO
tasks.register('unitTest') {
    group = 'Verification'
    description = '–ó–∞–ø—É—Å–∫ JUnit-—Ç–µ—Å—Ç–æ–≤'
    dependsOn 'buildJar'
    doLast {
        println 'Tests run'
    }
}

tasks.register('music') {
    group = 'Custom'
    description = '–ú—É–∑–∏–∫ –ª—è –ª—è –ª—è –µ—Ö–µ—Ö–µ—Ö–µ—Ö–µ–µ—Ö–µ—Ö–µ—Ö–µ'
    dependsOn 'buildJar'
    doLast {
        println 'üéµ Music playing'

        File audioFile = file("music/golos-domovenka-kuzi.wav")
        AudioInputStream ais = AudioSystem.getAudioInputStream(audioFile)
        Clip clip = AudioSystem.getClip()
        clip.open(ais)
        clip.start()

        Thread.sleep((long) (clip.getMicrosecondLength() / 1000))

        clip.close()
        ais.close()
    }
}

tasks.register('native2ascii') {
    group = 'Localization'
    description = 'Convert all .properties from UTF-8 to ASCII escapes using Ant native2ascii'

    def srcDir = file('src/main/resources')
    def destDir = layout.buildDirectory.dir('converted-resources').get().asFile

    inputs.dir srcDir
    outputs.dir destDir

    doFirst {
        println '***** NATIVE2ASCII STARTED *****'
        if (destDir.exists()) {
            destDir.deleteDir()
        }
        destDir.mkdirs()
    }

    doLast {
        ant.native2ascii(
                src: srcDir,
                dest: destDir,
                encoding: 'UTF-8',
                includes: '**/*.properties'
        )
        println '***** NATIVE2ASCII COMPLETED *****'
    }
}


// TODO
tasks.register('doc', Javadoc) {
    group = 'Documentation'
    description = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JavaDoc'
    destinationDir = file("$buildDir/docs/javadoc")
    options.encoding = 'UTF-8'
}

// TODO
tasks.register('docArchive', Zip) {
    group = 'Documentation'
    description = '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ JavaDoc —Å MD5 –∏ SHA1'
    dependsOn 'doc'
    from doc.destinationDir
    archiveFileName = "docs-${project.version}.zip"
    doLast {
        println '–í—ã—á–∏—Å–ª—è–µ–º MD5 –∏ SHA1 –¥–ª—è —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...'
        fileTree(dir: doc.destinationDir, include: '**/*').files.each { File file ->
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è MD5
            def md5 = file.bytes.encodeHex().toString()
            file("${file}.md5").text = md5
            def sha1Digest = java.security.MessageDigest.getInstance("SHA-1")
            sha1Digest.update(file.bytes)
            def sha1 = sha1Digest.digest().encodeHex().toString()
            file("${file}.sha1").text = sha1
        }
    }
}

tasks.register('xmlValidate') {
    group = 'Verification'
    description = '–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö XML-—Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (DocumentBuilder)'
    doLast {
        println 'Validating XML-file...'
        def factory = DocumentBuilderFactory.newInstance()
        factory.setNamespaceAware(true)
        factory.setValidating(false)
        def builder = factory.newDocumentBuilder()
        fileTree(dir: 'src/main/resources/', include: '*.xml').each { File xmlFile ->
            try {
                xmlFile.withInputStream { is -> builder.parse(is) }
                println "OK: ${xmlFile}"
            } catch (Exception e) {
                throw new GradleException("Validation error XML: ${xmlFile}", e)
            }
        }
    }
}

//TODO
tasks.register('scp') {
    group = 'Deployment'
    description = '–ü–µ—Ä–µ–Ω–æ—Å —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ jar-—Ñ–∞–π–ª–∞ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø–æ SCP'
    dependsOn 'buildJar'
    doLast {
        println 'Scp command run'
    }
    // –ó–∞–º–µ–Ω–∏—Ç–µ user@server:/path –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    // commandLine 'scp', "${buildDir}/libs/${project.name}-${project.version}.jar", 'user@server:/remote/path/'
}

//TODO
tasks.register('team') {
    group = 'Custom'
    description = '–ü–æ–ª—É—á–µ–Ω–∏–µ 4 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–≤–∏–∑–∏–π –∏–∑ SVN –∏ —Å–±–æ—Ä–∫–∞ –∏—Ö –≤ zip'
    doLast {
        println '–ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ä–µ–≤–∏–∑–∏–∏ –∏–∑ SVN...'
        def revisions = []
        def log = 'svn log -l 4 --quiet'.execute().text
        log.eachLine { line ->
            if (line =~ /^r(\d+)/) {
                revisions << (line =~ /^r(\d+)/)[0][1]
            }
        }
        def tmpDir = file("$buildDir/svnRevs")
        tmpDir.mkdirs()
        revisions.each { rev ->
            println "–û–±–Ω–æ–≤–ª—è–µ–º SVN –¥–æ —Ä–µ–≤–∏–∑–∏–∏ $rev –∏ —Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
            exec { commandLine 'svn', 'update', '-r', rev }
            exec { commandLine 'gradle', 'buildJar' }  // —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –∑–∞–¥–∞—á
            copy {
                from "${buildDir}/libs/${project.name}-${project.version}.jar"
                into tmpDir
                rename { "${project.name}-${rev}.jar" }
            }
        }
        ant.zip(destfile: "$buildDir/archives/team_revisions.zip", basedir: tmpDir)
        println '–ì–æ—Ç–æ–≤ –∞—Ä—Ö–∏–≤ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–µ–≤–∏–∑–∏—è–º–∏.'
    }
}

tasks.register('runJava8', JavaExec) {
    group = 'Run'
    description = '–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥ Java 8'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = mainClass
    javaLauncher = javaToolchains.launcherFor {
        languageVersion = JavaLanguageVersion.of(8)
    }
    jvmArgs = ['-Xms256m', '-Xmx512m']
}

tasks.register('runWithArgs', JavaExec) {
    group = 'Run'
    description = '–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ VM-–∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = mainClass
    args 'arg1', 'arg2'
    jvmArgs '-Dexample.property=value', '-Xmx1024m'
}

tasks.register('report') {
    group = 'Reporting'
    description = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JUnit-–æ—Ç—á—ë—Ç–∞ (XML) –∏ –∫–æ–º–º–∏—Ç –≤ Git'
    dependsOn 'unitTest'
    doLast {
        println '–ö–æ–º–º–∏—Ç–∏–º –æ—Ç—á–µ—Ç JUnit –≤ Git...'
        exec { commandLine 'git', 'add', "${buildDir}/test-results/test/TEST-*.xml" }
        exec { commandLine 'git', 'commit', '-m', "Add JUnit report" }
    }
}

tasks.register('alt') {
    group = 'Custom'
    description = '–°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Å –∑–∞–º–µ–Ω–æ–π –∏–º—ë–Ω —á–µ—Ä–µ–∑ regex'
    doLast {
        println '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–µ–∫—Ç–∞ —Å –∑–∞–º–µ–Ω–æ–π –∏–º—ë–Ω...'
        def altSrcDir = file("$buildDir/altSrc")
        copy {
            from 'src/main/java'
            into altSrcDir
            filter { String line -> line.replaceAll('OldName', 'NewName') }
        }
        ant.javac(srcdir: altSrcDir, destdir: "$buildDir/altClasses",
                classpath: configurations.compileClasspath.asPath)
        ant.jar(destfile: "$buildDir/libs/${project.name}-alt.jar", basedir: "$buildDir/altClasses",
                manifest: ['Main-Class': mainClass])
        println '–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π jar —Å–æ–∑–¥–∞–Ω: ' + "$buildDir/libs/${project.name}-alt.jar"
    }
}

tasks.register('diff') {
    group = 'Version Control'
    description = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è git –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π'
    doLast {
        println '–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Git...'
        def status = 'git status --porcelain'.execute().text.trim()
        if (status) {
            println '–ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ–º–º–∏—Ç–∏–º...'
            exec { commandLine 'git', 'add', '--all' }
            exec { commandLine 'git', 'commit', '-m', "Auto commit changes" }
        } else {
            println '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞.'
        }
    }
}

tasks.register('history') {
    group = 'Version Control'
    description = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º SVN-—Ä–µ–≤–∏–∑–∏—è–º, –µ—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –Ω–µ—É–¥–∞—á–Ω–∞'
    doLast {
        println '–ü—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç...'
        def currentRev = ('svn info --show-item revision'.execute().text.trim() as int)
        def rev = currentRev
        while (rev > 0) {
            try {
                exec { commandLine 'gradle', 'buildJar' }
                println "–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏ $rev."
                break
            } catch (Exception e) {
                rev--
                if (rev <= 0) {
                    println '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –Ω–∏ –æ–¥–Ω—É —Ä–µ–≤–∏–∑–∏—é.'
                    break
                }
                println "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º –æ—Ç–∫–∞—Ç –∫ —Ä–µ–≤–∏–∑–∏–∏ $rev..."
                exec { commandLine 'svn', 'update', '-r', rev.toString() }
            }
        }
    }
}
